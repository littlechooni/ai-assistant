<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/chat_styles.css">
    <title>INPET AI Chat</title>
</head>
<body>
    <div class="chat-header">
        <div class="icon" id="backButton">
            <img src="/images/back-icon.png" alt="Back">
        </div>
        <h2>INPET AI</h2>
        <div class="icon" id="menuIcon"></div>
    </div>

    <div class="chat-container" id="chatContainer"></div>

    <div class="input-container">
        <input type="text" class="message-input" id="messageInput" placeholder="Message" minlength="5">
        <button class="send-button" id="sendButton" disabled>
            <img src="/images/request.png" alt="Request" id="sendButtonImage">
        </button>
    </div>

    <!-- Full-screen Modal -->
    <div id="fullScreenModal" class="modal">
        <div class="modal-content">
        </div>
    </div>


    <input type="hidden" id="cat_name" th:value="${name}">
    <input type="hidden" id="query" th:value="${query}"> <!-- Replace 12345 with the actual cat_id -->
    <input type="hidden" id="prompt_add" th:value="${prompt_add}">
    <input type="hidden" id="cat_id" th:value="${cat_id}">
    <input type="hidden" id="cat_profile_img" th:value="${cat_profile_img}">
    <input type="hidden" id="lang" th:value="${lang}">
    <input type="hidden" id="member_grade" th:value="${member_grade}">
    <input type="hidden" id="request_count" th:value="${request_count}">

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" class="custom-modal">
        <div class="custom-modal-content">
            <p id="customAlertMessage">Message</p>
            <button onclick="closeCustomAlert()"></button>
        </div>
    </div>

    <script>
         /*<![CDATA[*/

        const menuIcon = document.getElementById('menuIcon');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const backButton = document.getElementById('backButton'); // Back button reference
        const sendButtonImage = document.getElementById('sendButtonImage'); //
        const serverQuery = document.getElementById('query');  // query (Thymeleaf
        const promptElement = document.getElementById('prompt_add');
        const cat_id = document.getElementById('cat_id').value;
        const lang = document.getElementById('lang').value;
        const member_grade = document.getElementById('member_grade').value;
        const request_count = document.getElementById('request_count').value;
        const promptValue = promptElement ? promptElement.value.trim() : ""; // GPT Prompt
        const new_count = 0;

        let catProfileImg = '[[${cat_profile_img}]]';

        // userIconPath
        const userIconPath = (catProfileImg.trim() != 0)
          ? `https://objectstorage.us-sanjose-1.oraclecloud.com/n/axkskmvuve8e/b/inpetBucket/o/${catProfileImg}`: '/images/no_cat_img.png';
        const aiIconPath = '/images/ai-icon.png';

        const errorMessage = '[[${errorMessage}]]';
        if (errorMessage) {
            alert(errorMessage);
        }

        menuIcon.addEventListener('click', function () {
            const cat_name = document.getElementById('cat_name').value;
            const cat_profile_img = document.getElementById('cat_profile_img').value;
            const prompt_add = document.getElementById('prompt_add').value;

            // Current timestamp to prevent caching
            const timestamp = new Date().getTime();

            // Construct the URL with query parameters
            const url = `/queryhistory?name=${encodeURIComponent(cat_name)}&cat_profile_img=${encodeURIComponent(cat_profile_img)}&prompt_add=${encodeURIComponent(prompt_add)}&cat_id=${encodeURIComponent(cat_id)}&_=${timestamp}&lang=${encodeURIComponent(lang)}`;

            // Show modal and load content dynamically
            const modal = document.getElementById('fullScreenModal');
            const modalContent = document.querySelector('.modal-content');

            // Create an iframe to load the URL in the modal
            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';

            // Clear previous content and append iframe
            modalContent.innerHTML = '<span class="close" id="closeModal">&times;</span>';
            modalContent.appendChild(iframe);

            // Display the modal
            modal.style.display = 'block';

            // Set focus on the modal for accessibility
            modal.setAttribute('tabindex', '-1'); // Allow the modal to receive focus
            modal.focus();  // Set focus on the modal

            // Close the modal when the close button is clicked
            const closeModal = document.getElementById('closeModal');
            closeModal.addEventListener('click', function () {
                modal.style.display = 'none';
            });

            // Close the modal when the user clicks anywhere outside the modal
            window.addEventListener('click', function (e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            const lang = document.getElementById('lang').value || 'en'; // lang (en)
            const messageInput = document.getElementById('messageInput');

            // placeholder
            const placeholders = {
                en: "Message",
                ko: "메시지 입력 (5글자 이상)"
            };

            // lang placeholder
            if (messageInput) {
                messageInput.placeholder = placeholders[lang] || placeholders['en'];
            }
        });


        // iframe
        window.addEventListener('message', (event) => {
            const cat_id = document.getElementById('cat_id').value;
            const cat_name = document.getElementById('cat_name').value;
            const cat_profile_img = document.getElementById('cat_profile_img').value;
            const prompt_add = document.getElementById('prompt_add').value;
            const lang = document.getElementById('lang').value;

            function postToProcessSearch(query) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/processSearch';

                const params = {
                    query: query,
                    name: cat_name,
                    cat_profile_img: cat_profile_img,
                    prompt_add: prompt_add,
                    cat_id: cat_id,
                    lang: lang
                };

                for (const key in params) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = params[key];
                    form.appendChild(input);
                }

                document.body.appendChild(form);
                form.submit();
            }

            if (event.data.type === 'newSearch') {
                const modal = document.getElementById('fullScreenModal');
                modal.style.display = 'none';

                if (cat_id.trim() !== "" && cat_name.trim() !== "") {
                    postToProcessSearch(''); //
                } else {
                    alert('Please enter some text to search.');
                }
            } else {
                const data = event.data.data;
                const { query } = data;

                if (cat_id.trim() !== "" && cat_name.trim() !== "") {
                    postToProcessSearch(query); //
                } else {
                    alert('Please enter some text to search.');
                }
            }
        });





        function addMessage(text, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;

            //
            const iconDiv = document.createElement('div');
            iconDiv.className = 'message-icon';

            //
            const img = document.createElement('img');
            img.src = isUser ? userIconPath : aiIconPath;  // AI
            img.alt = isUser ? 'User Icon' : 'AI Icon';
            img.width = 32;  //
            img.height = 32;
            iconDiv.appendChild(img);
            messageDiv.appendChild(iconDiv);

            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            messageDiv.appendChild(textSpan);

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        let messageHistory = [];

        async function getAIResponse(userMessage, promptValue) {

            const cnt_check = parseInt(document.getElementById('request_count').value, 10);
            const new_count = cnt_check + 1;

            //const apiUrl = 'http://ec2-3-34-107-70.ap-northeast-2.compute.amazonaws.com:8080/api/chat/start';  // dev
            //const apiUrl = 'http://inpet.thelittlecat.kr/inpet/api/chat/start';
            //const apiUrl = 'http://localhost:8080/api/chat/start';  //

            const apiUrl = '/api/chat/start';
            //
            messageHistory.push({
                role: "user",
                content: userMessage
            });
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        cat_id : cat_id,
                        prompt_add: promptValue,
                        messages: messageHistory  //
                    }),
                });

                document.getElementById('request_count').value = new_count;

                if (!response.ok) {
                    throw new Error(`Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const MAX_HISTORY_SIZE = 10;
                if (data.header && data.header.resultCode === '0000') {
                    messageHistory.push({
                        role: "assistant",
                        content: data.body.response
                    });

                //
                if (messageHistory.length > MAX_HISTORY_SIZE) {
                    //
                    const excess = messageHistory.length - MAX_HISTORY_SIZE;
                    messageHistory = messageHistory.slice(excess);
                }

                    return {
                        response: data.body.response || "Sorry, I didn't understand that.",
                        catImageUrl: data.body.cat_img_url || null,
                        catId: data.body.cat_id || null,
                    };
                } else {
                    return { response: "An unexpected error occurred.", catImageUrl: null, catId: null };
                }



            } catch (error) {
                console.error('Error fetching AI response:', error);
                return { response: "An error occurred while fetching the AI response.", catImageUrl: null, catId: null };
            }
        }

        async function handleSend() {
            const message = messageInput.value.trim();
            const chk_count = document.getElementById('request_count').value;

            if (chk_count > 2 &&  member_grade > 3) {
                const limitquestion = lang === 'ko' ? "질의는 하루에 3회까지만 가능합니다." : "You can make up to 3 inquiries per day.";
                showCustomAlert(limitquestion);
                return;
            }

            if (message.length >= 5) {
                addMessage(message, true);
                messageInput.value = '';

                // Add loading state
                const inputContainer = document.querySelector('.input-container');
                inputContainer.classList.add('loading');
                sendButton.disabled = true;
                sendButtonImage.src = '/images/request.png';

                // Add loading message
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message ai-message loading-message';
                const iconDiv = document.createElement('div');
                iconDiv.className = 'message-icon';
                const img = document.createElement('img');
                img.src = aiIconPath;
                img.alt = 'AI Icon';
                img.width = 32;
                img.height = 32;
                iconDiv.appendChild(img);
                loadingDiv.appendChild(iconDiv);

                const loadingText = document.createElement('span');
                loadingText.textContent = lang === 'ko' ? '답변 작성 중' : 'Thinking';
                const dots = document.createElement('span');
                dots.className = 'loading-dots';
                loadingText.appendChild(dots);
                loadingDiv.appendChild(loadingText);

                chatContainer.appendChild(loadingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                try {
                    const aiData = await getAIResponse(message, promptValue);
                    // Remove loading message
                    chatContainer.removeChild(loadingDiv);
                    addMessage(aiData.response, false);
                } catch (error) {
                    // Remove loading message
                    chatContainer.removeChild(loadingDiv);
                    addMessage('An error occurred while getting the response.', false);
                } finally {
                    // Remove loading state
                    inputContainer.classList.remove('loading');
                    // Re-enable input based on content length
                    sendButton.disabled = messageInput.value.trim().length < 5;
                }
            }
        }

        messageInput.addEventListener('input', () => {
            // 5
            if (messageInput.value.trim().length >= 5) {
                sendButton.disabled = false;
                sendButtonImage.src = '/images/ph_arrow-up-light.png'; //
            } else {
                sendButton.disabled = true;
                sendButtonImage.src = '/images/request.png'; //
            }
        });


        sendButton.addEventListener('click', handleSend);
        messageInput.addEventListener('keypress', (e) => {

            if (e.key === 'Enter') {
                handleSend();
            }
        });

        // Add back button functionality
        backButton.addEventListener('click', () => {
            const timestamp = new Date().getTime(); //
            const url = `/home?catId=${encodeURIComponent(cat_id)}&lang=${encodeURIComponent(lang)}&forceReload=${timestamp}`;
            window.location.replace(url); // assign replacehistory
        });



        // query
        function loadQueryFromServer() {
            if (serverQuery) {
                messageInput.value = serverQuery.value;  // query
                handleSend();  // AI
            }
        }

        //
        function updateContent() {
            const style = document.createElement('style'); //
            style.innerHTML = `
                .user-message .message-icon::before {
                    content: var(--message-text, '[[${name}]]'); /* */
                }
            `;
            document.head.appendChild(style); // head
        }

        //
        updateContent();
        loadQueryFromServer();
        function showCustomAlert(message) {
            const modal = document.getElementById('customAlertModal');
            const messageEl = document.getElementById('customAlertMessage');
            messageEl.textContent = message;
            modal.style.display = 'block';
        }

        function closeCustomAlert() {
            document.getElementById('customAlertModal').style.display = 'none';
        }
         /*]]>*/
    </script>
</body>
</html>
