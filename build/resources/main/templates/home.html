<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INPET AI Assistant</title>
    <link rel="stylesheet" href="/css/styles.css?v=20250702">
</head>
<style>
    /* placeholder 텍스트 스타일 */
    input::placeholder {
        color: #d3d3d3; /* 연한 회색 */
    }


</style>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <!-- 뒤로가기 아이콘을 이미지로 교체 -->
            <span class="icon" id="backIcon">
                <img src="/images/back-icon.png" alt="Back">
            </span>
            <h2>INPET AI</h2>
            <span class="icon" id="menuIcon">☰</span>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message-content" id="welcomeMessage">What can I help you with today?</div>

            <!-- ✅ 프로필 이미지 썸네일 영역 -->
            <div class="profile-thumbnail">
                <img id="catThumbnail" src="" alt="Cat Thumbnail">
            </div>

            <div class="input-container">
                <input type="text" id="searchInput" placeholder="Check today's health metrics">
                <div class="search-icon" onclick="handleSearchClick()"></div>
            </div>
            <!-- 1번째 버튼 -->
            <div class="input-container_sub" onclick="handleButtonClick(1)">
                <input type="button" id="button1" value="🐾 &quot;How is my cat's health on INPET?&quot;">
            </div>
            <!-- 2번째 버튼 -->
            <div class="input-container_sub_sub" onclick="handleButtonClick(2)">
                <input type="button" id="button2" value="💊 &quot;My cat gained weight - what should I do?&quot;">
            </div>
            <!-- 3번째 버튼 -->
            <div class="input-container_sub_sub" onclick="handleButtonClick(3)">
                <input type="button" id="button3" value="🍽️ &quot;What's the right portion size for my cat?&quot;">
            </div>
            <!-- 4번째 버튼 -->
            <div class="input-container_sub_sub" onclick="handleButtonClick(4)">
                <input type="button" id="button4" value="📱 &quot;How do I connect my INPET device to the app?&quot;">
            </div>
        </div>

    </div>
    <!-- Full-screen Modal -->
    <div id="fullScreenModal" class="modal">
        <div class="modal-content">
        </div>
    </div>

    <!-- Add a hidden input or dynamically retrieve the cat_id -->
    <input type="hidden" id="cat_name" th:value="${cat_name}">
    <input type="hidden" id="cat_id" th:value="${cat_id}">
    <input type="hidden" id="cat_profile_img" th:value="${cat_profile_img}">
    <input type="hidden" id="prompt_add" th:value="${prompt_add}">
    <input type="hidden" id="lang" th:value="${lang}">
    <input type="hidden" id="member_grade" th:value="${member_grade}">
    <input type="hidden" id="request_count" th:value="${request_count}">

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" class="custom-modal">
        <div class="custom-modal-content">
            <p id="customAlertMessage">Message</p>
            <button onclick="closeCustomAlert()">확인</button>
        </div>
    </div>


    <script>
        // 햄버거 아이콘 클릭 시 팝업 열기
        const menuIcon = document.getElementById('menuIcon');
        const backIcon = document.getElementById('backIcon');

        document.addEventListener('DOMContentLoaded', function () {
            const lang = document.getElementById('lang').value || 'en'; // 서버에서 전달받은 lang 값
            const profileImgUrl = document.getElementById('cat_profile_img').value;

            // 썸네일 이미지 src 설정
            const thumbnail = document.getElementById('catThumbnail');
            const userIconPath = (profileImgUrl && profileImgUrl !== "0")
                ? `https://objectstorage.us-sanjose-1.oraclecloud.com/n/axkskmvuve8e/b/inpetBucket/o/${profileImgUrl}`
                : '/images/no_cat_img.png';

            if (thumbnail) {
                thumbnail.src = userIconPath;
            }

            // 다국어 메시지
            const messages = {
                en: {
                    welcome: "What can I help you with today?",
                    placeholder: "Check today's health metrics",
                    button1: "🐾 \"How is my cat's health on INPET?\"",
                    button2: "💊 \"My cat gained weight - what should I do?\"",
                    button3: "🍽️ \"What's the right portion size for my cat?\"",
                    button4: "📱 \"How do I connect my INPET device to the app?\""
                },
                ko: {
                    welcome: "오늘 무엇을 도와드릴까요?",
                    placeholder: "오늘의 건강 지표를 확인하세요",
                    button1: "🐾 \"INPET에서 내 고양이의 건강 상태는 어떤가요?\"",
                    button2: "💊 \"내 고양이가 살이 쪘어요. 어떻게 해야 하나요?\"",
                    button3: "🍽️ \"내 고양이의 적절한 식사량은 얼마인가요?\"",
                    button4: "📱 \"INPET 장치를 앱에 어떻게 연결하나요?\""
                }
            };

            // 언어에 따라 텍스트 변경
            const currentMessages = messages[lang] || messages['en'];

            document.getElementById('welcomeMessage').textContent = currentMessages.welcome;
            document.getElementById('searchInput').placeholder = currentMessages.placeholder;
            document.getElementById('button1').value = currentMessages.button1;
            document.getElementById('button2').value = currentMessages.button2;
            document.getElementById('button3').value = currentMessages.button3;
            document.getElementById('button4').value = currentMessages.button4;
        });


        // iOS와 Android를 구별하기 위한 함수
        function detectOS() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;

            if (/iPhone|iPad|iPod/i.test(userAgent)) {
                return 'iOS';
            } else if (/android/i.test(userAgent)) {
                return 'Android';
            } else {
                return 'Other';
            }
        }

        // backIcon 클릭 시 동작
        backIcon.addEventListener('click', function () {
            const os = detectOS();
            if (os === 'iOS') {
                // iOS에서만 실행할 스크립트
               window.webkit.messageHandlers.iOSApp.postMessage("closeWebView");
            } else if (os === 'Android') {
                // Android에서만 실행할 스크립트
               AndroidBridge.close();
            } else {
            }
        });

        menuIcon.addEventListener('click', function () {
            const cat_id = document.getElementById('cat_id').value;
            const cat_name = document.getElementById('cat_name').value;
            const cat_profile_img = document.getElementById('cat_profile_img').value;
            const prompt_add = document.getElementById('prompt_add').value;
            const lang = document.getElementById('lang').value;

            // Current timestamp to prevent caching
            const timestamp = new Date().getTime();

            // Construct the URL with query parameters
            const url = `/queryhistory?name=${encodeURIComponent(cat_name)}&cat_profile_img=${encodeURIComponent(cat_profile_img)}&prompt_add=${encodeURIComponent(prompt_add)}&cat_id=${encodeURIComponent(cat_id)}&_=${timestamp}&lang=${encodeURIComponent(lang)}`;

            // Show modal and load content dynamically
            const modal = document.getElementById('fullScreenModal');
            const modalContent = document.querySelector('.modal-content');

            // Create an iframe to load the URL in the modal
            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';

            // Clear previous content and append iframe
            modalContent.innerHTML = '<span class="close" id="closeModal">&times;</span>';
            modalContent.appendChild(iframe);

            // Display the modal
            modal.style.display = 'block';

            // Set focus on the modal for accessibility
            modal.setAttribute('tabindex', '-1'); // Allow the modal to receive focus
            modal.focus();  // Set focus on the modal

            // Close the modal when the close button is clicked
            const closeModal = document.getElementById('closeModal');
            closeModal.addEventListener('click', function () {
                modal.style.display = 'none';
            });

            // Close the modal when the user clicks anywhere outside the modal
            window.addEventListener('click', function (e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });


        function handleButtonClick(number) {
            // 버튼 클릭 시 실행할 JavaScript 코드
            let message = "";
            const lang = document.getElementById('lang').value || 'en'; // 서버에서 전달받은 lang 값

                switch (number) {
                    case 1:
                        message = lang === 'ko'
                            ? "INPET에서 내 고양이의 건강 상태는 어떤가요?"
                            : "How is my cat's health on INPET?";
                        break;
                    case 2:
                        message = lang === 'ko'
                            ? "내 고양이가 살이 쪘어요. 어떻게 해야 하나요?"
                            : "My cat gained weight - what should I do?";
                        break;
                    case 3:
                        message = lang === 'ko'
                            ? "내 고양이의 적절한 식사량은 얼마인가요?"
                            : "What's the right portion size for my cat?";
                        break;
                    case 4:
                        message = lang === 'ko'
                            ? "INPET 장치를 앱에 어떻게 연결하나요?"
                            : "How do I connect my INPET device to the app?";
                        break;
                    default:
                        message = lang === 'ko'
                            ? "INPET이란?"
                            : "Unknown option";
                }

            document.getElementById('searchInput').value = message;
            handleSearchClick();
        }

        function handleSearchClick() {
            // Get the search input value and cat_id
            const inputValue = document.getElementById('searchInput').value;
            const cat_id = document.getElementById('cat_id').value;
            const cat_name = document.getElementById('cat_name').value;
            const cat_profile_img = document.getElementById('cat_profile_img').value;
            const prompt_add = document.getElementById('prompt_add').value;
            const lang = document.getElementById('lang').value;
            const member_grade = document.getElementById('member_grade').value;
            const request_count = document.getElementById('request_count').value;

            // 최소 5글자 확인
            if (inputValue.length < 5) {
                showCustomAlert('최소 5자 이상 입력해 주세요.');
                return;
            }

            if (request_count > 2 &&  member_grade > 3) {
                showCustomAlert('질의는 하루에 3회까지만 가능합니다.');
                return;
            }

            // Redirect to /processSearch with both query and cat_id
            if (inputValue.trim() !== "" && cat_name.trim() !== "") {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/processSearch';

                const params = {
                    query: inputValue,
                    name: cat_name,
                    cat_profile_img: cat_profile_img,
                    prompt_add: prompt_add,
                    cat_id: cat_id,
                    lang: lang,
                    member_grade: member_grade,
                    request_count: request_count
                };

                for (const key in params) {
                    if (params.hasOwnProperty(key)) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = params[key];
                        form.appendChild(input);
                    }
                }

                document.body.appendChild(form);
                form.submit();
            } else {
                alert('Please enter some text to search.');
            }

        }

        // Add an event listener for the Enter key
        document.getElementById('searchInput').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                const inputValue = document.getElementById('searchInput').value;
                if (inputValue.length < 5) {
                    showCustomAlert('최소 5자 이상 입력해 주세요.');
                    return;
                }
                handleSearchClick();
            }
        });


        // iframe에서 메시지를 받으면 처리하는 이벤트 리스너
        window.addEventListener('message', (event) => {
            const cat_id = document.getElementById('cat_id').value;
            const cat_name = document.getElementById('cat_name').value;
            const cat_profile_img = document.getElementById('cat_profile_img').value;
            const prompt_add = document.getElementById('prompt_add').value;
            const lang = document.getElementById('lang').value;
            const member_grade = document.getElementById('member_grade').value;
            const request_count = document.getElementById('request_count').value;

            function postToProcessSearch(params) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/processSearch';

                for (const key in params) {
                    if (params.hasOwnProperty(key)) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = params[key];
                        form.appendChild(input);
                    }
                }

                document.body.appendChild(form);
                form.submit();
            }

            if (event.data.type === 'newSearch') {
                const modal = document.getElementById('fullScreenModal');
                modal.style.display = 'none';

                if (cat_id.trim() !== "" && cat_name.trim() !== "") {
                    postToProcessSearch({
                        query: '',
                        name: cat_name,
                        cat_profile_img: cat_profile_img,
                        prompt_add: prompt_add,
                        cat_id: cat_id,
                        lang: lang,
                        member_grade: member_grade,
                        request_count: request_count
                    });
                } else {
                    alert('Please enter some text to search.');
                }
            } else {
                const data = event.data.data;
                const { query } = data;
                const quest_query = `${query}`;

                if (cat_id.trim() !== "" && cat_name.trim() !== "") {
                    postToProcessSearch({
                        query: quest_query,
                        name: cat_name,
                        cat_profile_img: cat_profile_img,
                        prompt_add: prompt_add,
                        cat_id: cat_id,
                        lang: lang,
                        member_grade: member_grade,
                        request_count: request_count
                    });
                } else {
                    alert('Please enter some text to search.');
                }
            }
        });

        function showCustomAlert(message) {
            const modal = document.getElementById('customAlertModal');
            const messageEl = document.getElementById('customAlertMessage');
            messageEl.textContent = message;
            modal.style.display = 'block';
        }

        function closeCustomAlert() {
            document.getElementById('customAlertModal').style.display = 'none';
        }

    </script>


</body>
</html>
