<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INPET AI Assistant</title>
    <link rel="stylesheet" href="/css/styles.css?v=20250702">
</head>
<style>
    /* placeholder í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    input::placeholder {
        color: #d3d3d3; /* ì—°í•œ íšŒìƒ‰ */
    }


</style>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <!-- ë’¤ë¡œê°€ê¸° ì•„ì´ì½˜ì„ ì´ë¯¸ì§€ë¡œ êµì²´ -->
            <span class="icon" id="backIcon">
                <img src="/images/back-icon.png" alt="Back">
            </span>
            <h2>INPET AI</h2>
            <span class="icon" id="menuIcon">â˜°</span>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message-content" id="welcomeMessage">What can I help you with today?</div>

            <!-- âœ… í”„ë¡œí•„ ì´ë¯¸ì§€ ì¸ë„¤ì¼ ì˜ì—­ -->
            <div class="profile-thumbnail">
                <img id="catThumbnail" src="" alt="Cat Thumbnail">
            </div>

            <div class="input-container">
                <input type="text" id="searchInput" placeholder="Check today's health metrics">
                <div class="search-icon" onclick="handleSearchClick()"></div>
            </div>
            <!-- 1ë²ˆì§¸ ë²„íŠ¼ -->
            <div class="input-container_sub" onclick="handleButtonClick(1)">
                <input type="button" id="button1" value="ğŸ¾ &quot;How is my cat's health on INPET?&quot;">
            </div>
            <!-- 2ë²ˆì§¸ ë²„íŠ¼ -->
            <div class="input-container_sub_sub" onclick="handleButtonClick(2)">
                <input type="button" id="button2" value="ğŸ’Š &quot;My cat gained weight - what should I do?&quot;">
            </div>
            <!-- 3ë²ˆì§¸ ë²„íŠ¼ -->
            <div class="input-container_sub_sub" onclick="handleButtonClick(3)">
                <input type="button" id="button3" value="ğŸ½ï¸ &quot;What's the right portion size for my cat?&quot;">
            </div>
            <!-- 4ë²ˆì§¸ ë²„íŠ¼ -->
            <div class="input-container_sub_sub" onclick="handleButtonClick(4)">
                <input type="button" id="button4" value="ğŸ“± &quot;How do I connect my INPET device to the app?&quot;">
            </div>
        </div>

    </div>
    <!-- Full-screen Modal -->
    <div id="fullScreenModal" class="modal">
        <div class="modal-content">
        </div>
    </div>

    <!-- Add a hidden input or dynamically retrieve the cat_id -->
    <input type="hidden" id="cat_name" th:value="${cat_name}">
    <input type="hidden" id="cat_id" th:value="${cat_id}">
    <input type="hidden" id="cat_profile_img" th:value="${cat_profile_img}">
    <input type="hidden" id="prompt_add" th:value="${prompt_add}">
    <input type="hidden" id="lang" th:value="${lang}">
    <input type="hidden" id="member_grade" th:value="${member_grade}">
    <input type="hidden" id="request_count" th:value="${request_count}">

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" class="custom-modal">
        <div class="custom-modal-content">
            <p id="customAlertMessage">Message</p>
            <button onclick="closeCustomAlert()">í™•ì¸</button>
        </div>
    </div>


    <script>
        // í–„ë²„ê±° ì•„ì´ì½˜ í´ë¦­ ì‹œ íŒì—… ì—´ê¸°
        const menuIcon = document.getElementById('menuIcon');
        const backIcon = document.getElementById('backIcon');

        document.addEventListener('DOMContentLoaded', function () {
            const lang = document.getElementById('lang').value || 'en'; // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ lang ê°’
            const profileImgUrl = document.getElementById('cat_profile_img').value;

            // ì¸ë„¤ì¼ ì´ë¯¸ì§€ src ì„¤ì •
            const thumbnail = document.getElementById('catThumbnail');
            const userIconPath = (profileImgUrl && profileImgUrl !== "0")
                ? `https://objectstorage.us-sanjose-1.oraclecloud.com/n/axkskmvuve8e/b/inpetBucket/o/${profileImgUrl}`
                : '/images/no_cat_img.png';

            if (thumbnail) {
                thumbnail.src = userIconPath;
            }

            // ë‹¤êµ­ì–´ ë©”ì‹œì§€
            const messages = {
                en: {
                    welcome: "What can I help you with today?",
                    placeholder: "Check today's health metrics",
                    button1: "ğŸ¾ \"How is my cat's health on INPET?\"",
                    button2: "ğŸ’Š \"My cat gained weight - what should I do?\"",
                    button3: "ğŸ½ï¸ \"What's the right portion size for my cat?\"",
                    button4: "ğŸ“± \"How do I connect my INPET device to the app?\""
                },
                ko: {
                    welcome: "ì˜¤ëŠ˜ ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?",
                    placeholder: "ì˜¤ëŠ˜ì˜ ê±´ê°• ì§€í‘œë¥¼ í™•ì¸í•˜ì„¸ìš”",
                    button1: "ğŸ¾ \"INPETì—ì„œ ë‚´ ê³ ì–‘ì´ì˜ ê±´ê°• ìƒíƒœëŠ” ì–´ë–¤ê°€ìš”?\"",
                    button2: "ğŸ’Š \"ë‚´ ê³ ì–‘ì´ê°€ ì‚´ì´ ìª˜ì–´ìš”. ì–´ë–»ê²Œ í•´ì•¼ í•˜ë‚˜ìš”?\"",
                    button3: "ğŸ½ï¸ \"ë‚´ ê³ ì–‘ì´ì˜ ì ì ˆí•œ ì‹ì‚¬ëŸ‰ì€ ì–¼ë§ˆì¸ê°€ìš”?\"",
                    button4: "ğŸ“± \"INPET ì¥ì¹˜ë¥¼ ì•±ì— ì–´ë–»ê²Œ ì—°ê²°í•˜ë‚˜ìš”?\""
                }
            };

            // ì–¸ì–´ì— ë”°ë¼ í…ìŠ¤íŠ¸ ë³€ê²½
            const currentMessages = messages[lang] || messages['en'];

            document.getElementById('welcomeMessage').textContent = currentMessages.welcome;
            document.getElementById('searchInput').placeholder = currentMessages.placeholder;
            document.getElementById('button1').value = currentMessages.button1;
            document.getElementById('button2').value = currentMessages.button2;
            document.getElementById('button3').value = currentMessages.button3;
            document.getElementById('button4').value = currentMessages.button4;
        });


        // iOSì™€ Androidë¥¼ êµ¬ë³„í•˜ê¸° ìœ„í•œ í•¨ìˆ˜
        function detectOS() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;

            if (/iPhone|iPad|iPod/i.test(userAgent)) {
                return 'iOS';
            } else if (/android/i.test(userAgent)) {
                return 'Android';
            } else {
                return 'Other';
            }
        }

        // backIcon í´ë¦­ ì‹œ ë™ì‘
        backIcon.addEventListener('click', function () {
            const os = detectOS();
            if (os === 'iOS') {
                // iOSì—ì„œë§Œ ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸
               window.webkit.messageHandlers.iOSApp.postMessage("closeWebView");
            } else if (os === 'Android') {
                // Androidì—ì„œë§Œ ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸
               AndroidBridge.close();
            } else {
            }
        });

        menuIcon.addEventListener('click', function () {
            const cat_id = document.getElementById('cat_id').value;
            const cat_name = document.getElementById('cat_name').value;
            const cat_profile_img = document.getElementById('cat_profile_img').value;
            const prompt_add = document.getElementById('prompt_add').value;
            const lang = document.getElementById('lang').value;

            // Current timestamp to prevent caching
            const timestamp = new Date().getTime();

            // Construct the URL with query parameters
            const url = `/queryhistory?name=${encodeURIComponent(cat_name)}&cat_profile_img=${encodeURIComponent(cat_profile_img)}&prompt_add=${encodeURIComponent(prompt_add)}&cat_id=${encodeURIComponent(cat_id)}&_=${timestamp}&lang=${encodeURIComponent(lang)}`;

            // Show modal and load content dynamically
            const modal = document.getElementById('fullScreenModal');
            const modalContent = document.querySelector('.modal-content');

            // Create an iframe to load the URL in the modal
            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';

            // Clear previous content and append iframe
            modalContent.innerHTML = '<span class="close" id="closeModal">&times;</span>';
            modalContent.appendChild(iframe);

            // Display the modal
            modal.style.display = 'block';

            // Set focus on the modal for accessibility
            modal.setAttribute('tabindex', '-1'); // Allow the modal to receive focus
            modal.focus();  // Set focus on the modal

            // Close the modal when the close button is clicked
            const closeModal = document.getElementById('closeModal');
            closeModal.addEventListener('click', function () {
                modal.style.display = 'none';
            });

            // Close the modal when the user clicks anywhere outside the modal
            window.addEventListener('click', function (e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });


        function handleButtonClick(number) {
            // ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰í•  JavaScript ì½”ë“œ
            let message = "";
            const lang = document.getElementById('lang').value || 'en'; // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ lang ê°’

                switch (number) {
                    case 1:
                        message = lang === 'ko'
                            ? "INPETì—ì„œ ë‚´ ê³ ì–‘ì´ì˜ ê±´ê°• ìƒíƒœëŠ” ì–´ë–¤ê°€ìš”?"
                            : "How is my cat's health on INPET?";
                        break;
                    case 2:
                        message = lang === 'ko'
                            ? "ë‚´ ê³ ì–‘ì´ê°€ ì‚´ì´ ìª˜ì–´ìš”. ì–´ë–»ê²Œ í•´ì•¼ í•˜ë‚˜ìš”?"
                            : "My cat gained weight - what should I do?";
                        break;
                    case 3:
                        message = lang === 'ko'
                            ? "ë‚´ ê³ ì–‘ì´ì˜ ì ì ˆí•œ ì‹ì‚¬ëŸ‰ì€ ì–¼ë§ˆì¸ê°€ìš”?"
                            : "What's the right portion size for my cat?";
                        break;
                    case 4:
                        message = lang === 'ko'
                            ? "INPET ì¥ì¹˜ë¥¼ ì•±ì— ì–´ë–»ê²Œ ì—°ê²°í•˜ë‚˜ìš”?"
                            : "How do I connect my INPET device to the app?";
                        break;
                    default:
                        message = lang === 'ko'
                            ? "INPETì´ë€?"
                            : "Unknown option";
                }

            document.getElementById('searchInput').value = message;
            handleSearchClick();
        }

        function handleSearchClick() {
            // Get the search input value and cat_id
            const inputValue = document.getElementById('searchInput').value;
            const cat_id = document.getElementById('cat_id').value;
            const cat_name = document.getElementById('cat_name').value;
            const cat_profile_img = document.getElementById('cat_profile_img').value;
            const prompt_add = document.getElementById('prompt_add').value;
            const lang = document.getElementById('lang').value;
            const member_grade = document.getElementById('member_grade').value;
            const request_count = document.getElementById('request_count').value;

            // ìµœì†Œ 5ê¸€ì í™•ì¸
            if (inputValue.length < 5) {
                showCustomAlert('ìµœì†Œ 5ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                return;
            }

            if (request_count > 2 &&  member_grade > 3) {
                showCustomAlert('ì§ˆì˜ëŠ” í•˜ë£¨ì— 3íšŒê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            // Redirect to /processSearch with both query and cat_id
            if (inputValue.trim() !== "" && cat_name.trim() !== "") {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/processSearch';

                const params = {
                    query: inputValue,
                    name: cat_name,
                    cat_profile_img: cat_profile_img,
                    prompt_add: prompt_add,
                    cat_id: cat_id,
                    lang: lang,
                    member_grade: member_grade,
                    request_count: request_count
                };

                for (const key in params) {
                    if (params.hasOwnProperty(key)) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = params[key];
                        form.appendChild(input);
                    }
                }

                document.body.appendChild(form);
                form.submit();
            } else {
                alert('Please enter some text to search.');
            }

        }

        // Add an event listener for the Enter key
        document.getElementById('searchInput').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                const inputValue = document.getElementById('searchInput').value;
                if (inputValue.length < 5) {
                    showCustomAlert('ìµœì†Œ 5ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                    return;
                }
                handleSearchClick();
            }
        });


        // iframeì—ì„œ ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ë©´ ì²˜ë¦¬í•˜ëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        window.addEventListener('message', (event) => {
            const cat_id = document.getElementById('cat_id').value;
            const cat_name = document.getElementById('cat_name').value;
            const cat_profile_img = document.getElementById('cat_profile_img').value;
            const prompt_add = document.getElementById('prompt_add').value;
            const lang = document.getElementById('lang').value;
            const member_grade = document.getElementById('member_grade').value;
            const request_count = document.getElementById('request_count').value;

            function postToProcessSearch(params) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/processSearch';

                for (const key in params) {
                    if (params.hasOwnProperty(key)) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = params[key];
                        form.appendChild(input);
                    }
                }

                document.body.appendChild(form);
                form.submit();
            }

            if (event.data.type === 'newSearch') {
                const modal = document.getElementById('fullScreenModal');
                modal.style.display = 'none';

                if (cat_id.trim() !== "" && cat_name.trim() !== "") {
                    postToProcessSearch({
                        query: '',
                        name: cat_name,
                        cat_profile_img: cat_profile_img,
                        prompt_add: prompt_add,
                        cat_id: cat_id,
                        lang: lang,
                        member_grade: member_grade,
                        request_count: request_count
                    });
                } else {
                    alert('Please enter some text to search.');
                }
            } else {
                const data = event.data.data;
                const { query } = data;
                const quest_query = `${query}`;

                if (cat_id.trim() !== "" && cat_name.trim() !== "") {
                    postToProcessSearch({
                        query: quest_query,
                        name: cat_name,
                        cat_profile_img: cat_profile_img,
                        prompt_add: prompt_add,
                        cat_id: cat_id,
                        lang: lang,
                        member_grade: member_grade,
                        request_count: request_count
                    });
                } else {
                    alert('Please enter some text to search.');
                }
            }
        });

        function showCustomAlert(message) {
            const modal = document.getElementById('customAlertModal');
            const messageEl = document.getElementById('customAlertMessage');
            messageEl.textContent = message;
            modal.style.display = 'block';
        }

        function closeCustomAlert() {
            document.getElementById('customAlertModal').style.display = 'none';
        }

    </script>


</body>
</html>
